version: '3.9'
services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_DB: uem
      POSTGRES_USER: uem_user
      POSTGRES_PASSWORD: change-me
    ports: ["5432:5432"]
    volumes: ["pgdata:/var/lib/postgresql/data"]

  redis:
    image: redis:7
    ports: ["6379:6379"]

  rabbitmq:
    image: rabbitmq:3-management
    environment:
      RABBITMQ_DEFAULT_USER: uem
      RABBITMQ_DEFAULT_PASS: uem
    ports: ["5672:5672", "15672:15672"]

  auth-service:
    build: { context: .., dockerfile: backend/Dockerfile }
    command: uvicorn backend.services.auth_service.app.main:app --host 0.0.0.0 --port 8001
    env_file: [../.env.example]
    ports: ["8001:8001"]
    depends_on: [postgres, redis, rabbitmq]

  device-service:
    build: { context: .., dockerfile: backend/Dockerfile }
    command: uvicorn backend.services.device_service.app.main:app --host 0.0.0.0 --port 8002
    env_file: [../.env.example]
    ports: ["8002:8002"]
    depends_on: [postgres, redis, rabbitmq]

  task-service:
    build: { context: .., dockerfile: backend/Dockerfile }
    command: uvicorn backend.services.task_service.app.main:app --host 0.0.0.0 --port 8003
    env_file: [../.env.example]
    ports: ["8003:8003"]
    depends_on: [postgres, redis, rabbitmq]

  api-gateway:
    image: nginx:1.27-alpine
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/nginx.conf:ro
    ports: ["8080:8080"]
    depends_on: [auth-service, device-service, task-service]

volumes:
  pgdata:
